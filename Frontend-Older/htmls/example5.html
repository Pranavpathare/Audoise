<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RecordRTC over Websocket</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css"
    />

    <script src="https://www.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.js"></script>
  </head>

  <body>
    <div style="margin: 20px">
      <h1 style="font-size: 18px">
        Example 4: Speech to Text Transcribe Recognize Call
      </h1>

      <div>
        <button id="start-recording">Start Recording</button>
        <button id="stop-recording">Stop Recording</button>
      </div>

      <h2 style="font-size: 14px">Results: Yaay</h2>
      <textarea id="results" style="width: 800px; height: 300px"></textarea>
    </div>

    <script type="text/javascript">
      const endpoint = "ws://127.0.0.1:8000/ws/splitted";

      const ws = new WebSocket(endpoint);
      const startRecording = document.getElementById("start-recording");
      const stopRecording = document.getElementById("stop-recording");
      let recordAudio;

      ws.onopen = (event) => {
        startRecording.disabled = false;
        ws.send(
          JSON.stringify({
            type: "open",
          })
        );
      };

      ws.onclose = (event) => {
        console.info("Connection to websocket closed");
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log(data);
      };

      startRecording.onclick = function () {
        startRecording.disabled = true;

        navigator.getUserMedia(
          {
            audio: true,
          },
          function (stream) {
            recordAudio = RecordRTC(stream, {
              type: "audio",
              mimeType: "audio/webm",
              sampleRate: 44100,
              recorderType: StereoAudioRecorder,
              numberOfAudioChannels: 1,
              timeSlice: 4000,
              desiredSampRate: 16000,
            });

            recordAudio.startRecording();
            stopRecording.disabled = false;
          },
          function (error) {
            console.error(JSON.stringify(error));
          }
        );
      };

      stopRecording.onclick = function () {
        startRecording.disabled = false;
        stopRecording.disabled = true;

        recordAudio.stopRecording(function () {
          recordAudio.getDataURL(function (audioDataURL) {
            var files = {
              audio: {
                type: recordAudio.getBlob().type || "audio/wav",
                dataURL: audioDataURL,
              },
            };

            if (ws.readyState === WebSocket.OPEN) {
              console.log(files);
              ws.send(files.audio.dataURL);
            }
          });
        });
      };
    </script>
  </body>
</html>
